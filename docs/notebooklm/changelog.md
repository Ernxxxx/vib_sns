# Vib SNS 開発変更履歴

このドキュメントは、Vib SNSの開発履歴と主要な変更内容をまとめたものです。

---

## 最新の変更（時系列順）

### 2024年12月末 - 通知機能の大幅改善

#### 通知UIの刷新
- 通知欄のUI改善と投稿いいね通知の遷移対応
- 返信通知のボタン順序を変更（いいね→返信）
- 通知タップ時の背景色をグレーに統一
- リプライバッジの表示を有効化
- いいね数・返信数の表示安定化（0でもスペース確保）

#### 通知タップ時の遷移
- 「投稿にいいねしました」通知にpostIdを追加し、タップで投稿詳細へ遷移可能に
- 「あなたにいいねしました」（プロフィールいいね）と「投稿にいいね」を区別
- `getPost`メソッドを追加し、タイムライン外の投稿も取得・遷移可能に

#### リプライ機能の改善
- 通知欄から返信した際に親リプライのreplyCountも更新
- 非同期処理の順序を修正（コンテキスト消失防止）
- リプライ数バグ修正: ローカルの楽観的更新を廃止し、Firestoreの値を正として二重カウントを解消

#### 通知重複の防止
- 既存通知との重複チェック処理を追加（フォロー・いいね）
- リスナー更新タイミングを調整し、非同期処理による競合を解決

---

### 投稿詳細画面のモダン化

#### ネストリプライ機能
- 折りたたみ可能なスレッド形式リプライを実装
- 投稿者本人のリプライは自動展開
- リプライへのリプライ（ネストリプライ）対応

#### 画像機能
- 画像タップでフルスクリーン表示
- ダウンロード機能を追加

#### その他
- いいねのリアルタイム反映と楽観的更新を実装
- 投稿者本人による投稿削除機能を追加
- UI文言を日本語化（時間表示、プレースホルダー）
- 画面間のいいね数同期問題を修正
- アバターアイコンのスタイルをタイムラインと統一
- 日付フォーマットをYYYY/MM/DD形式に変更

---

### アカウント管理機能

#### 設定画面の追加
- ログアウト・アカウント削除機能を SettingsScreen に集約
- アカウント削除時にFirebase Authユーザーも削除

#### ユーザーID機能
- ユーザーID (@username) の重複登録を防止するバリデーションを追加
- プロフィール設定時のユーザーIDリアルタイム重複チェックを実装
- ユーザーIDを必須項目に変更

#### 認証フロー
- 表示名ログインのフローを簡略化（中間画面のスキップ）
- プロフィール画面に「プロフィールを編集」ボタンを追加

---

### DM機能の強化

- DM機能の強化とメッセージ管理機能を追加
- 画像送信機能
- リアルタイムメッセージ更新
- 未読管理

---

### タイムラインUIの刷新

#### デザイン変更
- Threads風のクリーンなデザインに変更
- ハートボタンのみのシンプルなアクション
- いいね数をハートの右に数字のみで表示
- 投稿作成モーダルのGlassmorphismデザイン

#### 投稿機能
- ハッシュタグのチップ形式化
- 投稿ヘッダー（アイコン・名前）タップによるプロフィール画面への遷移
- マイページに自身のタイムライン投稿リストを追加

#### 更新機能
- 各主要画面にPull-to-Refresh機能を追加
  - ホーム
  - すれ違いリスト
  - 通知
  - マイページ

---

### いいね機能の修正

#### バグ修正
- いいね時の投稿・画像フリッカー問題を修正
- `replaceRange`を使用したアトミック更新に変更

#### 動作改善
- タイムラインのいいねがプロフィールのいいね数に反映されない問題を修正
  - `profiles/{authorId}/likes`サブコレクションにもドキュメントを追加/削除
- いいねの楽観的更新がFirestoreリスナーに上書きされる問題を修正
- 投稿いいねとプロフィールいいねを分離し合計表示を統一

---

### 振動ロジックの修正

#### 変更内容
- ハッシュタグ一致時のみ振動するように修正
  - プロフィール# + 投稿# の組み合わせで比較
- タイムライン投稿削除時に該当ユーザーからの振動を抑制する機能を追加
- 動的クールダウン（距離に応じて5秒〜30秒）を復元
- プロフィールハッシュタグ比較を復活（振動条件の修正）

---

### すれ違いリストの改善

- 24時間の有効期限を追加
- すれ違いリストの時刻表示が常に「たった今」になる問題を修正
  - BLE検知のたびにencounteredAtがリセットされていたのを削除

---

### エモーションマップ

#### 気持ち投稿モーダル
- モーダルがフルスクリーンにならないよう修正
- `isDismissible`/`enableDrag`を有効化し外タップで閉じられるように

---

### プロフィール機能

- デフォルトアバターを人型アイコン・統一背景色に変更
- プロフィール画面のタイムラインにタブ追加（投稿 / メディア）
- デザイン統一

---

### データ可視化ダッシュボード

- VIB SNSのデータを可視化するダッシュボードを追加（PR #6）

---

### 桜スタンプ機能

- 100+桜スタンプの画像をズームアップ表示（中の桜を強調）
- スタンプの外枠を細くし、画像が主役になるよう調整
- 舞い散る花びらエフェクトを前面に配置
- 投稿成功時にコンポーザーを自動的に閉じるように改善

---

## 機能一覧（実装済み）

### コア機能
- [x] すれちがい検出（GPS + BLE）
- [x] プロフィール管理
- [x] タイムライン投稿
- [x] いいね機能
- [x] フォロー機能
- [x] ダイレクトメッセージ
- [x] 通知機能
- [x] エモーションマップ

### 認証
- [x] 匿名認証
- [x] Googleログイン
- [x] ログアウト
- [x] アカウント削除

### UI/UX
- [x] Pull-to-Refresh
- [x] Glassmorphismデザイン
- [x] ダークモード対応（Material 3）
- [x] 日本語UI

### セキュリティ
- [x] Firestoreセキュリティルール
- [x] ユーザーID重複チェック
- [x] 認証状態管理

---

## 今後の予定（TODO）

### 高優先度
- [ ] プッシュ通知（Firebase Cloud Messaging）
- [ ] バッテリー最適化
- [ ] 位置情報のプライバシー強化

### 中優先度
- [ ] グループDM
- [ ] ブロック機能
- [ ] 投稿の通報機能

### 低優先度
- [ ] AR機能
- [ ] 多言語対応

---

## 技術的な改善履歴

### パフォーマンス
- アトミック更新による投稿フリッカーの解消
- 楽観的更新とFirestoreリスナーの競合解決
- 位置情報キャッシュによるAPI呼び出し削減

### コード品質
- 各状態管理クラスに`refresh`メソッドを追加
- 遷移ロジックの最適化
- 非同期処理の順序修正（コンテキスト消失防止）

### セキュリティ
- Cloud Functionでのアカウント削除処理
- Firestoreルールの強化
- 認証状態の一貫性確保

---

このドキュメントは、Vib SNSの開発変更履歴を網羅しています。
