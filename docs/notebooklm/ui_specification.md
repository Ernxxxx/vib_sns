# Vib SNS 画面・UI仕様書

このドキュメントは、Vib SNSの全画面と主要UIウィジェットの詳細仕様を網羅しています。

---

## 1. 画面構成（ナビゲーション）

### メインナビゲーション（BottomNavigationBar）

```
┌──────────────────────────────────────────┐
│                HomeShell                  │
├──────────┬──────────┬──────────┬─────────┤
│  タイム   │  すれ違い │   通知   │ マイページ │
│  ライン   │  リスト   │         │          │
│    📰    │    🤝    │   🔔    │    👤    │
└──────────┴──────────┴──────────┴─────────┘
```

### ナビゲーションインデックス

| インデックス | 画面名 | アイコン | 機能 |
|------------|--------|---------|------|
| 0 | タイムライン | `RssFeed` / `RssFeedOutlined` | 投稿フィード閲覧 |
| 1 | すれちがいリスト | `Group` / `GroupOutlined` | すれちがったユーザー一覧 |
| 2 | 通知 | `Notifications` / `NotificationsOutlined` | いいね・フォロー・リプライ通知 |
| 3 | マイページ | `Person` / `PersonOutline` | 自分のプロフィール |

---

## 2. 各画面の詳細

### 2.1 タイムライン画面 (`_TimelineScreen`)

**機能**:
- すれちがったユーザーや近くにいるユーザーの投稿を表示
- 共有ハッシュタグがある投稿を優先表示
- Pull-to-Refreshで更新可能
- 投稿作成ボタン（FAB）

**フィルタリングロジック**:
```dart
// タイムライン表示条件（いずれかを満たす）
1. 自分の投稿
2. すれちがったユーザーの投稿
3. 近接範囲内（BLE）のユーザーの投稿
4. 共通ハッシュタグがある投稿
```

**UI要素**:
- `_HighlightsSection`: 共鳴・再会カウントのハイライト表示
- `_TimelineComposer`: 投稿作成モーダル
- 各投稿カード: アバター、表示名、本文、画像、ハッシュタグ、いいねボタン

**ハイライトセクション**:
| 指標 | 説明 | 絵文字 |
|------|------|--------|
| 共鳴 (Resonance) | 共有ハッシュタグ+近接 または 相互いいね | ✨ |
| 再会 (Reunion) | 過去に共鳴したユーザーとの再すれちがい | 🎉 |

---

### 2.2 すれちがいリスト画面 (`EncounterListScreen`)

**機能**:
- 過去24時間のすれちがいを表示
- フィルター切り替え（すれちがい / 共鳴 / 再会）
- エモーションマップの表示
- Pull-to-Refresh対応
- スキャンボタン

**フィルターオプション**:
```dart
enum EncounterListFilter {
  encounter,   // すべてのすれちがい
  reunion,     // 再会のみ
  resonance,   // 共鳴のみ
}
```

**UIコンポーネント**:
- `_EncounterTile`: すれちがいユーザーのタイル
  - アバター、表示名、時刻、距離（GPS/BLE）
  - いいねボタン、フォローボタン
  - タップでプロフィール画面へ遷移
- `_HighlightEntryTile`: 共鳴/再会ユーザーのタイル
- `EmotionMap`: 地図上のエモーション表示

**エラー状態**:
- `_ErrorMessage`: エラーメッセージ表示
- `_LoadingMessage`: ローディング表示
- `_EmptyEncountersMessage`: 「すれちがいがありません」

**バナー**:
- `_BannerMessage`: ユーザー名未設定時などの警告バナー

---

### 2.3 通知画面（NotificationManagerから取得）

**通知タイプ**:
```dart
enum AppNotificationType {
  encounter,      // すれちがい通知
  like,           // プロフィールいいね
  follow,         // フォロー
  timelineLike,   // 投稿へのいいね
  reply,          // リプライ
}
```

**通知タイプ別の表示**:

| タイプ | アイコン | 色 | タイトル例 |
|--------|---------|-----|-----------|
| encounter | `celebration` | Orange | 「〇〇さんとすれ違いました」 |
| like | `favorite` | Red | 「〇〇さんがあなたにいいねしました」 |
| follow | `person_add` | Blue | 「〇〇さんがあなたをフォローしました」 |
| timelineLike | `thumb_up` | Blue | 「投稿にいいねされました」 |
| reply | `reply` | Green | リプライ本文のスニペット |

**スニペット生成**:
- リプライ/いいね通知: 最大24文字 + 「…」

---

### 2.4 マイページ画面

**表示内容**:
- プロフィールアバター（画像またはカラー）
- 表示名、ユーザーID（@username）
- 統計情報（フォロワー / フォロー中 / いいね）
- プロフィール情報（自己紹介、出身地、ハッシュタグ）
- QRコード表示
- 自分の投稿リスト（タブ: 投稿 / メディア）
- プロフィール編集ボタン
- 設定ボタン

**統計表示**:
```
フォロワー: XX  フォロー中: XX  いいね: XX
```

---

### 2.5 プロフィール詳細画面 (`ProfileViewScreen`)

**表示内容**:
- 他ユーザーのプロフィール情報
- アクションボタン:
  - いいね (LikeButton)
  - フォロー (FollowButton)
  - DM送信（条件を満たす場合のみ）
- ユーザーの投稿リスト

**DMボタン表示条件**:
```dart
// DM可能条件（いずれかを満たす）
1. 相互いいね
2. 共鳴状態（共有ハッシュタグ + 近接）
3. 相互フォロー
```

**タブ**:
- `_PostsTab`: テキスト投稿一覧
- `_MediaTab`: 画像付き投稿のサムネイルグリッド

---

### 2.6 投稿詳細画面 (`PostDetailScreen`)

**機能**:
- 投稿の全文表示
- 画像があればフルスクリーン表示可能
- リプライスレッド（ネスト対応）
- いいね機能
- 投稿者本人は削除可能

**リプライ機能**:
- ネストされたスレッド形式
- 投稿者本人のリプライは自動展開
- リプライへのリプライ（ネストリプライ）
- オリジナル投稿者のリプライには特別マーカー

**UIコンポーネント**:
- `_PostCard`: メイン投稿カード
- `_ReplyItem`: 個別リプライ（展開/折りたたみ可能）
- `_ReplyComposer`: リプライ入力エリア

---

### 2.7 チャット画面 (`ChatScreen`)

**機能**:
- 1対1のダイレクトメッセージ
- テキストメッセージ
- 画像送信
- リアルタイム更新
- 未読管理

**UIコンポーネント**:
- `_MessageBubble`: メッセージバブル（自分/相手で左右分け）
- 日付ラベル（ラベル区切り）
- 入力エリア（テキスト + 画像選択ボタン + 送信ボタン）

**メッセージ表示**:
- 自分のメッセージ: 右寄せ、プライマリカラー背景
- 相手のメッセージ: 左寄せ、グレー背景
- 画像: タップでフルスクリーン表示

---

### 2.8 プロフィール設定モーダル (`showProfileSetupModal`)

**入力項目**:

| フィールド | 必須 | バリデーション |
|-----------|------|---------------|
| 表示名 | ✅ | 空でない |
| ユーザーID | ✅ | 3〜20文字、英数字と_のみ、重複チェック |
| ハッシュタグ | ✅ | 2〜10件選択 |

**ユーザーID（username）のバリデーション**:
```dart
static String? validateUsername(String? username, {bool required = true}) {
  // 空チェック
  // 長さチェック（3〜20文字）
  // 許可文字チェック（[a-z0-9_]のみ）
  // 先頭文字チェック（英字で始まること）
}
```

**リアルタイム重複チェック**:
- 500msのデバウンス処理
- Firestoreの`profiles`コレクションを検索
- 重複時は「このユーザーIDは既に使用されています」エラー

---

## 3. 共通UIウィジェット

### 3.1 LikeButton (`like_button.dart`)

**バリアント**:
```dart
enum LikeButtonVariant {
  hero,  // 大きいサイズ（プロフィール詳細用）
  chip,  // 小さいサイズ（リスト用）
}
```

**アニメーション**:
- いいね時: バウンスアニメーション（0.85スケール）
- アイコン: `Icons.favorite` (いいね済み) / `Icons.favorite_border` (未いいね)
- 色: いいね済み = 赤 / 未いいね = グレー

**Heroバージョン**:
- グラデーション背景
- グローエフェクト
- いいね数表示
- 「いいね」ラベル

---

### 3.2 FollowButton (`like_button.dart`)

**状態**:
- フォロー済み: 「フォロー中」、アウトラインスタイル
- 未フォロー: 「フォローする」、塗りつぶしスタイル
- ローディング: スピナー表示

**アニメーション**:
- 押下時のスケールアニメーション

---

### 3.3 ProfileAvatar (`profile_avatar.dart`)

**表示**:
1. 優先: `avatarImageBase64`（Base64画像）
2. フォールバック: `avatarColor`（背景色 + 人型アイコン）

**サイズ**:
- 指定可能（デフォルト: 40）
- 円形クリップ

---

### 3.4 EmotionMap (`emotion_map.dart`)

**機能**:
- OpenStreetMap上にエモーションピンを表示
- 現在位置の表示
- エモーション投稿機能
- ボットスポット（東京周辺に自動生成）

**エモーションタイプ**:
```dart
enum EmotionType {
  happy,     // 😄 嬉しい
  sad,       // 😢 悲しい
  excited,   // 🎉 興奮
  calm,      // 😌 穏やか
  surprised, // 😮 驚き
  tired,     // 😫 疲れた
}
```

**ボットスポット**:
- 東京ドーム、コミケ会場など主要スポット
- 各スポットに固有のメモプール
- happy/sadの確率設定

**マーカー**:
- ガラスモーフィズムスタイル
- 絵文字表示
- メモ吹き出し

---

## 4. 投稿作成フロー

### 4.1 タイムライン投稿 (`_TimelineComposer`)

**入力項目**:
- キャプション（テキスト）
- 画像（オプション、ImagePicker経由）
- ハッシュタグ（プロフィールのハッシュタグから選択可能）

**画像処理**:
```dart
// 画像サイズ制限
maxWidth: 800
quality: 70

// リサイズ処理（imageパッケージ）
if (width > 800) {
  image = copyResize(image, width: 800);
}
```

**投稿フロー**:
```
1. キャプション入力
2. （オプション）画像選択 → リサイズ → Base64エンコード
3. ハッシュタグ選択/追加
4. 投稿ボタン押下
5. TimelineManager.addPost() 呼び出し
6. Firestoreに保存
7. 成功時: モーダルを閉じる
```

---

## 5. 認証フロー

### 5.1 初回起動時

```
アプリ起動
    │
    ▼
FirebaseAuth.currentUser == null?
    │
   Yes
    │
    ▼
匿名認証 (signInAnonymously)
    │
    ▼
プロフィール設定モーダル表示
    │
    ▼
表示名・ユーザーID・ハッシュタグ入力
    │
    ▼
プロフィール保存 → ホーム画面へ
```

### 5.2 Googleログイン（既存ユーザー）

```
Googleログインボタン押下
    │
    ▼
GoogleSignIn.signIn()
    │
    ▼
Firebase Authentication
    │
    ▼
プロフィール存在チェック
    │
   ├── 存在する → ホーム画面へ
    │
   └── 存在しない → プロフィール設定モーダル
```

### 5.3 ログアウト

```
設定画面 → ログアウト
    │
    ▼
確認ダイアログ
    │
    ▼
FirebaseAuth.signOut()
    │
    ▼
ローカルデータクリア
    │
    ▼
ログイン画面へ
```

---

## 6. 設定画面 (`SettingsScreen`)

**メニュー項目**:
- プロフィール編集
- ログアウト
- アカウント削除

**アカウント削除フロー**:
```
1. 確認ダイログ表示
2. Cloud Function `deleteUserProfile` 呼び出し
3. Firestoreの関連データ削除
   - profiles/{userId}
   - profiles/{userId}/followers
   - profiles/{userId}/following
   - profiles/{userId}/likes
   - profiles/{userId}/notifications
   - timelinePosts (authorId = userId)
   - streetpass_presences/{deviceId}
   - usernames/{username}
4. Firebase Authenticationユーザー削除
```

---

## 7. エラーメッセージ（日本語）

### 認証関連
| コード | メッセージ |
|--------|----------|
| user-not-found | ユーザーが見つかりません |
| wrong-password | パスワードが正しくありません |

### 位置情報関連
| エラー | メッセージ |
|--------|----------|
| permission-denied | 位置情報へのアクセスが許可されていません |
| service-disabled | 位置情報サービスが無効です。デバイスの設定を確認してください |
| position-unavailable | 位置情報が取得できませんでした。GPSを有効にして再起動してください |

### BLE関連
| 権限 | メッセージ |
|------|----------|
| locationWhenInUse | 位置情報 |
| bluetoothScan | Bluetoothのスキャン |
| bluetoothConnect | Bluetoothとの接続 |
| bluetoothAdvertise | Bluetoothの広告 |

---

## 8. プリセットハッシュタグ一覧

アプリには100個のプリセットハッシュタグが用意されています:

```
#共鳴, #音楽, #ゲーム, #カフェ, #旅, #温泉, #映画, #アニメ,
#スポーツ, #筋トレ, #読書, #写真, #アート, #テック, #プログラミング,
#デザイン, #ガジェット, #ガーデニング, #料理, #スイーツ, #コーヒー,
#紅茶, #散歩, #サウナ, #ヨガ, #ランニング, #自転車, #ハイキング,
#星空, #ドライブ, #DIY, #インテリア, #ファッション, #コスメ,
#ペット, #猫, #犬, #海, #山, #花, #自然, #キャンプ, #フェス,
#ライブ, #勉強, #語学, #英語, #仕事, #スタートアップ, #マーケティング,
#写真撮影, #動画編集, #配信, #イラスト, #漫画, #ボードゲーム,
#カードゲーム, #レトロゲーム, #VR, #メタバース, #AI, #クラフト,
#手芸, #アクセサリー, #フラワー, #観葉植物, #自炊, #レシピ,
#グルメ, #ラーメン, #寿司, #焼肉, #中華, #カレー, #パン,
#スープ, #モーニング, #夜景, #朝活, #夜活, #瞑想, #マインドフルネス,
#コーチング, #子育て, #家族, #恋愛, #友達, #コミュニティ, #福祉,
#ボランティア, #エコ, #サステナブル, #リモートワーク, #副業,
#投資, #節約, #占い, #ゲーム配信, #コスプレ
```

---

このドキュメントは、Vib SNSの全画面とUIウィジェットの仕様を網羅しています。
