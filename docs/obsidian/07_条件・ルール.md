# 条件・ルールまとめ

## すれちがい検出（StreetPass）
- Firestoreの `streetpass_presences` を監視/取得
- 近傍判定は以下の両方を満たす必要あり
  - `lastUpdatedMs` が一定時間以内（デフォルト10分）
  - GPS距離が一定以内（デフォルト100m）
- 同一相手の連続検出は30秒クールダウン

## バイブ条件（近接フィードバック）
- 共有ハッシュタグがある場合のみ振動
- 距離判定は BLE距離（優先）→ GPS距離
- 距離の上限
  - BLE検知時: 3m + 1.5mバッファ
  - GPS検知時: 10m
- クールダウンは距離で変動
  - 近いほど短い（最短5秒）
  - 遠いほど長い（最長30秒）
- WebではBLE距離の扱いを無効化

## ハッシュタグ一致時の軽いフィードバック
- 共有ハッシュタグがある場合のみ
- 1分のクールダウン
- Webでは無効

## 共鳴（Resonance）
- 条件: 「相互いいね」または「共有ハッシュタグ + 近接（=バイブ条件）」
- 共有ハッシュタグ判定は
  - プロフィールのタグ
  - 直近24時間の投稿タグ
  - 上記を合算して一致判定

## 再会（Reunion）
- 共鳴済みの相手と再検出
- 15分以上の間隔が必要

## すれちがい通知（アプリ内）
- 初回検出は通知
- BLEの出入りが検知できる場合は「退出後の再入」でも通知
- それ以外は15分のクールダウン

## DM解放条件
- いずれかを満たすとDM可能
  - 相互いいね
  - 共鳴（共有ハッシュタグ + 近接）
  - 相互フォロー

## タイムライン条件
- 投稿一覧の購読上限: 200件
- 投稿のハッシュタグ抽出は「直近24時間分」のみ
- いいねは楽観的更新 → Firestoreの反映で同期

## パラメータ一覧（調整ポイント）
- presence有効期限: 10分（`FirestoreStreetPassService._presenceTimeout`）
- すれ違い距離: 100m（`FirestoreStreetPassService._detectionRadiusMeters`）
- 同一相手の再検出クールダウン: 30秒（`FirestoreStreetPassService` 側の抑制）
- 近接距離（近い）: 3m（`EncounterManager._closeProximityRadiusMeters`）
- 近接距離（遠い）: 10m（`EncounterManager._farProximityRadiusMeters`）
- BLE距離バッファ: 1.5m（`EncounterManager._bleVibrationBufferMeters`）
- バイブ最短クールダウン: 5秒（`EncounterManager._minProximityCooldown`）
- バイブ最長クールダウン: 30秒（`EncounterManager._maxProximityCooldown`）
- ハッシュタグ一致フィードバック: 1分（`EncounterManager._hashtagMatchCooldown`）
- 再会クールダウン: 15分（`EncounterManager._reencounterCooldown`）
- 近接ステータス保持: 60秒（`EncounterManager._proximityTimeout`）
- タイムライン購読上限: 200件（`TimelineManager._subscribeToPosts`）
- タイムライン投稿のハッシュタグ抽出範囲: 24時間（`TimelineManager.getPostHashtagsForUser`）

## 条件変更の履歴（Gitコミット由来）
- 7afd04f: すれ違いリストに「直近24時間のみ表示」を追加
- 261812b: 近接時バイブ条件を一時的に緩和（共通タグなしでも振動）
- ab6a19f → a8e12c3: 振動条件を「投稿タグ一致のみ」へ一時変更
- 6ec485e: 振動条件を「共有ハッシュタグ必須」に復帰（プロフィール＋投稿の合算判定）/ 動的クールダウン復元
- d4bae6f: プロフィールのハッシュタグ比較を復活（振動条件の修正）

## 参照
- [[04_API・サービス]]
- [[05_画面仕様]]
