# アーキテクチャ

## 構成概要
- クライアント: Flutter（UI + 状態管理）
- バックエンド: Firebase（Auth / Firestore / Storage / FCM）
- デバイス機能: GPS / BLE / ローカル保存（SharedPreferences）

## 構成図（概念）
```
[Screens / Widgets]
        |
        v
[State Managers]
  - EncounterManager
  - TimelineManager
  - NotificationManager
  - EmotionMapManager
  - ProfileController
        |
        v
[Services]
  - StreetPassService (Firestore/Mock)
  - ProfileInteractionService (Firestore/Mock)
  - FirestoreDmService
  - FCMService
  - BleProximityScanner
        |
        v
[Firebase / Device APIs]
  - Auth / Firestore / Storage / FCM
  - GPS / BLE / SharedPreferences
```

## データフローの要点
- 起動時: LocalProfileLoader → ProfileController にローカルプロフィールを反映
- すれちがい: EncounterManager → StreetPassService → `streetpass_presences`
- タイムライン: TimelineManager → `timelinePosts` + `timelinePosts/{id}/replies`
- いいね/フォロー: ProfileInteractionService → `profiles/*/likes` / `followers` / `following`
- 通知: NotificationManager が follow/like/返信を監視しアプリ通知に変換
- DM: FirestoreDmService → `conversations` / `messages` + Storage（画像）
- プッシュ通知: FCMService → `profiles/{id}/fcmTokens`

## モック/ランタイム切替
- Firestore未接続時はMockサービスでUI検証
- StreetPassRuntimeConfigで挙動を切り替え

## 参照
- [[01_全体概要]]
- [[04_API・サービス]]
